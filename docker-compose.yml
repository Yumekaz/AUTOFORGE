version: "3.8"

services:
  autoforge:
    build:
      context: .
      dockerfile: Dockerfile
    image: autoforge:v1.0
    container_name: autoforge-pipeline
    environment:
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
      OLLAMA_TIMEOUT_SECONDS: ${OLLAMA_TIMEOUT_SECONDS:-420}
    volumes:
      - ./input:/autoforge/input
      - ./output:/autoforge/output
      - ./config:/autoforge/config
      - ./models:/autoforge/models
      - ./evidence:/autoforge/evidence
    command: ["--demo", "bms", "--mock"]

  service_stub:
    build:
      context: .
      dockerfile: Dockerfile
    image: autoforge:v1.0
    container_name: autoforge-service-stub
    command: ["integrations/service_stub/rest_bms_service.py"]
    ports:
      - "30509:30509"
    profiles: ["live"]

  hmi:
    build:
      context: .
      dockerfile: Dockerfile
    image: autoforge:v1.0
    container_name: autoforge-hmi
    command:
      [
        "scripts/live_hmi_dashboard.py",
        "--host",
        "0.0.0.0",
        "--port",
        "30600",
        "--service-url",
        "http://service_stub:30509",
      ]
    ports:
      - "30600:30600"
    depends_on:
      - service_stub
    profiles: ["live"]

# Usage:
#   docker compose up autoforge
#   docker compose --profile live up service_stub hmi
